name: ğŸ† Update Contributors

on:
  pull_request:
    types: [closed]
  issues:
    types: [closed]
  schedule:
    # ë§¤ì›” 1ì¼ ìë™ ì—…ë°ì´íŠ¸
    - cron: '0 0 1 * *'

jobs:
  update-contributors:
    if: github.event.pull_request.merged == true || github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: |
          npm install @octokit/rest
          
      - name: Update contributors
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { Octokit } = require('@octokit/rest');
            
            const octokit = new Octokit({
              auth: process.env.GITHUB_TOKEN
            });
            
            // Get all contributors
            const { data: contributors } = await octokit.rest.repos.listContributors({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // Get PRs and issues for each contributor
            const contributorStats = {};
            
            for (const contributor of contributors) {
              const { data: prs } = await octokit.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                creator: contributor.login,
                state: 'closed',
                per_page: 100
              });
              
              const mergedPRs = prs.filter(pr => pr.merged_at);
              
              const { data: issues } = await octokit.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                creator: contributor.login,
                state: 'closed',
                per_page: 100
              });
              
              contributorStats[contributor.login] = {
                name: contributor.login,
                avatar: contributor.avatar_url,
                contributions: contributor.contributions,
                mergedPRs: mergedPRs.length,
                issues: issues.length,
                profile: contributor.html_url
              };
            }
            
            // Generate badges
            function getBadge(stats) {
              const badges = [];
              
              if (stats.mergedPRs >= 10) badges.push('ğŸ¥‡ Gold Contributor');
              else if (stats.mergedPRs >= 5) badges.push('ğŸ¥ˆ Silver Contributor');
              else if (stats.mergedPRs >= 1) badges.push('ğŸ¥‰ Bronze Contributor');
              
              if (stats.issues >= 5) badges.push('ğŸ› Issue Hunter');
              
              return badges;
            }
            
            // Update CONTRIBUTORS.md
            let contributorsContent = fs.readFileSync('CONTRIBUTORS.md', 'utf8');
            
            // Generate Gold contributors section
            const goldContributors = Object.values(contributorStats)
              .filter(stats => stats.mergedPRs >= 10)
              .sort((a, b) => b.mergedPRs - a.mergedPRs);
              
            const goldSection = goldContributors.map(stats => 
              `- **[${stats.name}](${stats.profile})** - ${stats.mergedPRs} PRs, ${stats.contributions} commits`
            ).join('\n');
            
            // Generate Silver contributors section
            const silverContributors = Object.values(contributorStats)
              .filter(stats => stats.mergedPRs >= 5 && stats.mergedPRs < 10)
              .sort((a, b) => b.mergedPRs - a.mergedPRs);
              
            const silverSection = silverContributors.map(stats => 
              `- **[${stats.name}](${stats.profile})** - ${stats.mergedPRs} PRs, ${stats.contributions} commits`
            ).join('\n');
            
            // Generate Bronze contributors section
            const bronzeContributors = Object.values(contributorStats)
              .filter(stats => stats.mergedPRs >= 1 && stats.mergedPRs < 5)
              .sort((a, b) => b.mergedPRs - a.mergedPRs);
              
            const bronzeSection = bronzeContributors.map(stats => 
              `- **[${stats.name}](${stats.profile})** - ${stats.mergedPRs} PRs, ${stats.contributions} commits`
            ).join('\n');
            
            // Update sections
            contributorsContent = contributorsContent.replace(
              /### ğŸ¥‡ Gold Contributors \(10\+ ìŠ¹ì¸ëœ PR\)\n<!-- ì´ ì„¹ì…˜ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ -->/,
              `### ğŸ¥‡ Gold Contributors (10+ ìŠ¹ì¸ëœ PR)\n${goldSection || 'ì•„ì§ ê³¨ë“œ ê¸°ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.'}`
            );
            
            contributorsContent = contributorsContent.replace(
              /### ğŸ¥ˆ Silver Contributors \(5\+ ìŠ¹ì¸ëœ PR\)\n<!-- ì´ ì„¹ì…˜ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ -->/,
              `### ğŸ¥ˆ Silver Contributors (5+ ìŠ¹ì¸ëœ PR)\n${silverSection || 'ì•„ì§ ì‹¤ë²„ ê¸°ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.'}`
            );
            
            contributorsContent = contributorsContent.replace(
              /### ğŸ¥‰ Bronze Contributors \(1\+ ìŠ¹ì¸ëœ PR\)\n<!-- ì´ ì„¹ì…˜ì€ ìë™ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤ -->/,
              `### ğŸ¥‰ Bronze Contributors (1+ ìŠ¹ì¸ëœ PR)\n${bronzeSection || 'ì•„ì§ ë¸Œë¡ ì¦ˆ ê¸°ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.'}`
            );
            
            // Write updated content
            fs.writeFileSync('CONTRIBUTORS.md', contributorsContent);
            
            console.log('Contributors updated successfully!');
            
      - name: Update monthly stats
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get current month stats
            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: monthStart.toISOString(),
              per_page: 100
            });
            
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              since: monthStart.toISOString(),
              per_page: 100
            });
            
            const mergedPRs = prs.filter(pr => pr.merged_at);
            const uniqueContributors = new Set();
            
            mergedPRs.forEach(pr => uniqueContributors.add(pr.user.login));
            issues.forEach(issue => uniqueContributors.add(issue.user.login));
            
            const monthYear = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
            const statsLine = `${monthYear}: ${mergedPRs.length}ê°œ PR, ${issues.length}ê°œ ì´ìŠˆ, ${uniqueContributors.size}ëª… ê¸°ì—¬ì`;
            
            console.log('Monthly stats:', statsLine);
            
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add CONTRIBUTORS.md
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸ† Update contributors list [automated]"
            git push
          fi
          
  welcome-new-contributor:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if first contribution
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: context.payload.pull_request.user.login,
              state: 'closed'
            });
            
            const mergedPRs = prs.filter(pr => pr.merged_at);
            
            if (mergedPRs.length === 1) {
              // First contribution!
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `ğŸ‰ **ì²« ê¸°ì—¬ë¥¼ ì¶•í•˜í•©ë‹ˆë‹¤!** @${context.payload.pull_request.user.login}\n\n` +
                      `í™˜ì˜í•©ë‹ˆë‹¤! AI Intelligence Explosion Detection Red Teamì— ì²« ë²ˆì§¸ ê¸°ì—¬ë¥¼ í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.\n\n` +
                      `ğŸ… **Bronze Contributor** ë°°ì§€ë¥¼ íšë“í•˜ì…¨ìŠµë‹ˆë‹¤!\n\n` +
                      `ë‹¤ìŒ ë‹¨ê³„ë¡œ ë” ë§ì´ ê¸°ì—¬í•´ë³´ì„¸ìš”:\n` +
                      `- ğŸ¥ˆ Silver Contributor: 5ê°œ PR ìŠ¹ì¸ ì‹œ\n` +
                      `- ğŸ¥‡ Gold Contributor: 10ê°œ PR ìŠ¹ì¸ ì‹œ\n\n` +
                      `ê¸°ì—¬ì ê°€ì´ë“œ: [CONTRIBUTING.md](./CONTRIBUTING.md)\n` +
                      `ì»¤ë®¤ë‹ˆí‹° ì°¸ì—¬: [GitHub Discussions](../../discussions)\n\n` +
                      `í•¨ê»˜ ì•ˆì „í•œ AIì˜ ë¯¸ë˜ë¥¼ ë§Œë“¤ì–´ê°€ìš”! ğŸš€`
              });
            }
            
  monthly-recognition:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate monthly recognition
        uses: actions/github-script@v7
        with:
          script: |
            // This will run monthly to highlight top contributors
            console.log('Generating monthly contributor recognition...');
            
            // Create issue for monthly recognition
            const now = new Date();
            const monthYear = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' });
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ† ${monthYear} ê¸°ì—¬ì ê°ì‚¬ ì¸ì‚¬`,
              body: `# ${monthYear} ê¸°ì—¬ì ì—¬ëŸ¬ë¶„ê»˜ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤! ğŸ™\n\n` +
                    `ì´ë²ˆ ë‹¬ ìš°ë¦¬ í”„ë¡œì íŠ¸ì— ê¸°ì—¬í•´ì£¼ì‹  ëª¨ë“  ë¶„ë“¤ê»˜ ì§„ì‹¬ìœ¼ë¡œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.\n\n` +
                    `## ğŸ“Š ì´ë²ˆ ë‹¬ ì„±ê³¼\n` +
                    `- ìŠ¹ì¸ëœ PR: [ìë™ ìƒì„±]\n` +
                    `- í•´ê²°ëœ ì´ìŠˆ: [ìë™ ìƒì„±]\n` +  
                    `- ìƒˆë¡œìš´ ê¸°ì—¬ì: [ìë™ ìƒì„±]\n\n` +
                    `## ğŸŒŸ íŠ¹ë³„ ê°ì‚¬\n` +
                    `[ìˆ˜ë™ìœ¼ë¡œ ì‘ì„± ì˜ˆì •]\n\n` +
                    `ì—¬ëŸ¬ë¶„ì˜ ë…¸ë ¥ ë•ë¶„ì— AI ì•ˆì „ì„± ì—°êµ¬ê°€ í•œ ê±¸ìŒ ë” ë°œì „í–ˆìŠµë‹ˆë‹¤!\n\n` +
                    `ë‹¤ìŒ ë‹¬ì—ë„ í•¨ê»˜ í•´ì£¼ì„¸ìš” ğŸš€`,
              labels: ['monthly-recognition', 'community']
            });
